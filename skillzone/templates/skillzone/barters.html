{% extends 'partials/base.html' %}
{% block title %}My Barters{% endblock %}
{% block content %}
{% load dict_filters %}

<div class="container mt-5 pt-4 min-vh-100">
  <div class="row">
    <div class="col-12">
      <div class="sbz-page-header d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="sbz-page-title">My Barters</h1>
          <p class="sbz-page-subtitle mb-0">
            All barter requests you have sent or received.
          </p>
        </div>
      </div>

      <div class="sbz-card">
        <div class="sbz-card-body p-0">

          {% if barters %}
          <div class="table-responsive">
            <table class="table mb-0 sbz-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Status</th>
                  <th>Requested On</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody>
                {% for barter in barters %}
                <tr>
                  <td>{{ barter.id }}</td>
                  <td>{{ barter.user_from }}</td>
                  <td>{{ barter.user_to }}</td>

                  <td>
                    <span class="sbz-chip sbz-chip-{{ barter.status|lower }}">
                      {{ barter.status }}
                    </span>

                    {% if barter.status == "Accepted" %}
                      <small class="text-muted d-block">
                        Completion:
                        {{ barter.completed_by_from|yesno:"✔,✖" }} /
                        {{ barter.completed_by_to|yesno:"✔,✖" }}
                      </small>
                    {% endif %}
                  </td>

                  <td>{{ barter.date_requested|date:"d M Y, H:i" }}</td>

                  <td>
                    {# -------- ADMIN APPROVED → ACCEPT / REJECT -------- #}
                    {% if barter.status == "Admin Approved" and request.user == barter.user_to %}
                      <a href="{% url 'skillzone:update_barter_status' barter.id 'Accepted' %}"
                         class="btn btn-sm btn-success mr-2">
                        ✔ Accept
                      </a>
                      <a href="{% url 'skillzone:update_barter_status' barter.id 'Rejected' %}"
                         class="btn btn-sm btn-danger">
                        ✖ Reject
                      </a>
                    {% endif %}

                    {# -------- ACCEPTED → DUAL COMPLETION -------- #}
                    {% if barter.status == "Accepted" %}

                      {% if request.user == barter.user_from and not barter.completed_by_from %}
                        <a href="{% url 'skillzone:update_barter_status' barter.id 'Completed' %}"
                           class="btn btn-sm btn-primary">
                          ✓ Mark Completed
                        </a>

                      {% elif request.user == barter.user_to and not barter.completed_by_to %}
                        <a href="{% url 'skillzone:update_barter_status' barter.id 'Completed' %}"
                           class="btn btn-sm btn-primary">
                          ✓ Mark Completed
                        </a>

                      {% else %}
                        <span class="text-muted">
                          Waiting for other user to complete
                        </span>
                      {% endif %}

                    {% endif %}

                    {# -------- COMPLETED → FEEDBACK -------- #}
                    {% if barter.status == "Completed" %}
                      {% with fb=feedback_map|dict_get:barter.id %}
                        {% if fb %}
                          <button class="btn btn-sm btn-outline-info"
                                  data-toggle="modal"
                                  data-target="#feedbackModal{{ barter.id }}">
                            ✎ Edit Feedback
                          </button>
                        {% else %}
                          <button class="btn btn-sm sbz-btn-secondary"
                                  data-toggle="modal"
                                  data-target="#feedbackModal{{ barter.id }}">
                            ★ Give Feedback
                          </button>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% else %}
          <div class="p-4">
            <p class="text-muted mb-0">You don't have any barters yet.</p>
          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================= FEEDBACK MODALS ======================= -->
{% for barter in barters %}
<div class="modal fade" id="feedbackModal{{ barter.id }}" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content p-3">
      <form method="POST" action="{% url 'skillzone:give_feedback' barter.id %}">
        {% csrf_token %}

        <h4 class="mb-3">Leave Feedback</h4>

        {% with fb=feedback_map|dict_get:barter.id %}
        <label>Rating</label>
        <input type="number" name="rating" class="form-control"
               step="0.5" min="0" max="5"
               value="{{ fb.rating|default:'' }}" required />

        <label class="mt-3">Comment</label>
        <textarea name="comment" class="form-control" rows="4" required>
{{ fb.comment|default:'' }}</textarea>
        {% endwith %}

        <div class="mt-3 d-flex justify-content-end">
          <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}
